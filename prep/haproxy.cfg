global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
        stats timeout 30s
        user haproxy
        group haproxy
        daemon

defaults
        maxconn 10000
        log     global
        mode    tcp
        option  tcplog
        timeout connect 5000
        timeout client  50000
        timeout server  50000

frontend prep-proxy-7100
        bind *:7100

        #ACL Declarations
        acl whitelist src -f /etc/haproxy/whitelist.lst
        acl is_abuse src_http_req_rate(Abuse) ge 10  
        acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0   
        acl abuse_cnt src_get_gpc0(Abuse) gt 0
        
        #Rules
        tcp-request content reject if !whitelist
        tcp-request content track-sc0 src table Abuse
        tcp-request content reject if abuse_cnt

        use_backend prep-node-7100

frontend prep-proxy-9000
        bind *:9000

        #ACL Declarations
        acl whitelist src -f /etc/haproxy/whitelist.lst
        acl is_abuse src_http_req_rate(Abuse) ge 50  
        acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0   
        acl abuse_cnt src_get_gpc0(Abuse) gt 0
        
        #Rules
        tcp-request content reject if !whitelist
        tcp-request content track-sc0 src table Abuse
        tcp-request content reject if abuse_cnt

        use_backend prep-node-9000

backend prep-node-7100
        server node1 127.0.0.2:7200 maxconn 200

backend prep-node-9000
        server node1 127.0.0.2:9100 maxconn 200

backend Abuse
        stick-table type ip size 100K expire 5m store gpc0,http_req_rate(10s)
